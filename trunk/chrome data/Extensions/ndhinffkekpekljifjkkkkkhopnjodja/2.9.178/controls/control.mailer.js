(function(){var e=devhd.pkg("control");var a=devhd.control.BaseControl.prototype;var g=e.createClass("MailerControl",e.BaseControl);var d=devhd.i18n.L;g.initialize=function(){a.initialize.call(this);this.completionModel={data:[],max:15,multiple:",",getValue:c,onSelect:{$this:this,$fn:f}}};g.setMailer=function(h){this.mailer=h};g.setEntry=function(h){this.entry=h
};g.setAddressBook=function(h){this.addressBook=h};g.setMailRequestFiller=function(h){this.filler=h};g.destroy=function(){devhd.bindml.innerHTML(this.part,"");this.mailToElem=null;this.mailNoteElem=null;this.panelMailerElem=null;this.panelSendingElem=null;this.panelErrorElem=null;this.addressBook=null;this.mailer=null;this.filter=null;this.entry=null;
a.destroy.call(this)};g.display=function(){var h=this.part.getAttribute("data-refid");devhd.bindml.innerHTML(this.part,templates.mailer.form(this.completionModel,h,this.mailer.getMyEmailAddress(),this.home),false,this.home);this.mailToElem=this.element("mailTo");this.mailNoteElem=this.element("mailNote");this.panelMailerElem=this.element("panelMailer");
this.panelSendingElem=this.element("panelSending");this.panelErrorElem=this.element("panelError");this.bind("mailCancelAction","click",g.cancelIt);this.bind("mailSendAction","click",g.sendIt);this.bind(this.part,"keydown",g.dispatchKeys);var i=this;this.addressBook.askContacts(function(j){i.completionModel.data=j},function(j,k){});this.reset()};g.sendIt=function(){var i=this.getRecipients();
if(i.length==0||i.indexOf("@")<0){this.setMessage(d(248),1000);return}this.showSending();var h=this;this.mailer.askSendMail(b.call(this),function(){h.fire("onControlDoneSending",d(249))},function(j,k){h.showMailTo();h.setMessage(d(252),1000)})};g.cancelIt=function(){this.fire("onControlDoneSending")};g.dispatchKeys=function(h){if(h.keyCode==27){this.cancelIt();
devhd.events.cancelEvent(h);return}if((h.keyCode==77&&h.ctrlKey)||(h.keyCode==13&&(h.metaKey||h.ctrlKey))){this.sendIt();devhd.events.cancelEvent(h);return}};g.reset=function(){if(this.mailToElem==null){return}this.mailToElem.value="";this.mailNoteElem.value="";this.showMailTo();this.mailToElem.blur();this.mailToElem.focus()};g.showMailTo=function(){this.panelSendingElem.style.display="none";
this.panelMailerElem.style.display="block"};g.showSending=function(){this.panelSendingElem.style.display="block";this.panelMailerElem.style.display="none"};g.getRecipients=function(){return devhd.str.trim(this.mailToElem.value||"")};g.getNote=function(){return devhd.str.trim(this.mailNoteElem.value||"")};function b(){var h={to:this.getRecipients()};
if(this.filler){devhd.fn.callback(this.filler,h)}return h}function c(i,h){if(i.group){if(h==0){return d(d(250),i.displayName,i.contacts.length)}if(h==1){return i.displayName}if(h==2){return"g"}}if(i.displayName){if(h==0){return d(d(251),i.displayName,i.userEmails[0])}if(h==1){return i.userEmails[0]}if(h==2){return"u"}}if(i.userEmails){if(h==1||h==0){return i.userEmails[0]
}if(h==2){return"u"}}return"+x+x+x+"}function f(l){var j,k,h=[];if(l.kind=="g"&&l.value){k=this.addressBook.lookupGroupByName(l.value);if(k){for(j=0;j<k.length;j++){h.push(c(k[j],0))}}return h.join(", ")}return l.text}})();
(function(){var a=devhd.pkg("pages");var h=devhd.log.get("page.category");var f=devhd.i18n.L;a.CategoryPage=function(j){this.guid=j};var c=a.CategoryPage.prototype=new a.BasePage();c.service=function(k,j){this.pageInfo=k;this.width=j.width;if(this.pageInfo.uri=="latest"){this.categoryLabel="#latest"}else{this.categoryLabel=this.pageInfo.key}if(this.categoryLabel==null){h.error(36,"invalid category key: ",this.pageInfo.key,". Context: ",this.pageInfo.uri);
this.categoryLabel="#latest"}this.title=this.reader.formatTitle(this.categoryLabel);this.initBase(j);this.startRenderHTML()};c.destroy=function(l,k){this.waitingDisplayQueue=[];if(this.topArea!=null){this.topArea.destroy();this.topArea=null}this.subscriptions=null;this.feedLocationIndex=null;this.displayedSubscriptionIndex=null;this.pageModel=null;if(this.controls!=null){for(var j=0;
j<this.controls.length;j++){this.controls[j].destroy()}}this.controls=null;this.destroyBase()};c.canEmbed=function(){return this.categoryLabel.length>0&&this.categoryLabel.indexOf("feedly.")==-1&&this.categoryLabel.indexOf("#")==-1};c.showEmbedder=function(k){var j=this;this.home.askIncludeControl("embed",function(){var l=new devhd.control.EmbedControl();
l.setHome(j.home);l.setNetcaster(j.netcaster);l.setReader(j.reader);l.setCategoryLabel(j.categoryLabel);j.feedly.setMessageBarControl(l)})};c.showCustomizer=function(j){this.showListCustomizer(j.target)};c.startRenderHTML=function(){this._cancelAllVisualFinders();this.state="loading";this.subscriptions=this.trends.listRankedSubscriptions(this.categoryLabel,this.hideReadArticlesFilter());
if(this.categoryLabel=="#latest"){this.subscriptions=this.subscriptions.slice(0,200)}this.pageModel=this.edito.buildExpandedCategoryPageModel(this.categoryLabel,this.subscriptions,this.width,this.hideReadArticlesFilter());this.feedly.setNbrPages(this.pageModel.nbrPages);this.feedly.selectTab(this.categoryLabel);var l=[];for(var k=0;k<this.pageModel.parts.length;
k++){l.push(this.pageModel.parts[k].subscription.id)}this.feedly.pushContext({uri:this.pageInfo.uri,pageNumber:this.pageModel.pageNumber,title:this.title,level:1,category:this.categoryLabel,subscriptions:[]});this.feedly.setOptionsContent("");this.feedly.setPageTitle(templates.page.category.title(this.reader.formatTitle(this.categoryLabel)));this.updatePageTitleHint();
var j=this.reader.getCategoryUnreadCount(this.categoryLabel)||-1;if(this.pageModel.parts.length>0){this.pageElem.innerHTML=templates.page.category.layout(this.reader.formatTitle(this.categoryLabel),this.pageModel,this.width,this.home);this.element("aboutArea").innerHTML=templates.page.category.layoutAboutArea(this.reader.formatTitle(this.categoryLabel),this.pageModel,this.width,this.home);
this.element("aboutArea").style.display="block";if(j>20){var m=this;this.reco.askRecommendLatestEntries({category:this.categoryLabel,maxAge:this.feedly.getPagePreference("digestMaxAge")*3600*1000,excludeRead:this.hideReadArticlesFilter()},7,function(n){m.continueRenderHTML(n)})}else{this.continueRenderHTML([])}}else{this.pageElem.innerHTML=templates.page.category.empty(this.reader.formatTitle(this.categoryLabel))
}};c.continueRenderHTML=function(l){if(this.isDestroyed()==true){return}this.featuredIndex={};if(l!=null&&l.length>0){var k=this;this.home.askIncludeControl("recommendationArea",function(){k.topArea=new devhd.control.RecommendationAreaControl();k.topArea.setHome(k.home);k.topArea.setReader(k.reader);k.topArea.setFeatured(l);k.topArea.setPage(k);k.topArea.setDisplayMode(k.feedly.getDisplayMode());
k.topArea.setPart(k.element("headline"));k.topArea.display()});for(var j=0;j<l.length;j++){this.featuredIndex[l[j].getId()]=true}}else{this.element("featuredArea").style.display="none"}this.createFeedLocationIndex();this.state="loaded";this.displayedSubscriptionIndex={};this.displayedSubscriptionCount=0;this.coreZoneStart=0;this.coreZoneEnd=0;this.pendingDisplayQueue={};
this.pendingDisplayQueueSize=0;var k=this;if(this.requestedScrollTop==null){this.home.getDocument().defaultView.setTimeout(function(){k.lazyDisplay(0)},0)}};c.createFeedLocationIndex=function(){this.feedLocationIndex=[];for(var k=0;k<this.pageModel.parts.length;k++){var j=this.pageModel.parts[k].subscription.id;var l=this.element("main_"+j);if(l==null){h.error(265,"failed to lookup element for: ",j);
continue}this.feedLocationIndex.push({feedId:j,start:l.offsetTop,end:l.offsetTop+l.offsetHeight,part:this.pageModel.parts[k],element:l})}};c.updateFeedLocationIndex=function(){for(var j=0;j<this.feedLocationIndex.length;j++){var k=this.feedLocationIndex[j];k.start=k.element.offsetTop;k.end=k.element.offsetTop+k.element.offsetHeight}};c.lookupFeedLocation=function(j){for(var k=0;
k<this.feedLocationIndex.length;k++){if(this.feedLocationIndex[k].feedId==j){return this.feedLocationIndex[k]}}h.error(305,"feed not found: ",j,". Hint: ",this.feedLocationIndex.length);return null};c.isFullyLoaded=function(){return this.displayedSubscriptionCount==this.subscriptions.length};c.askLazyDisplay=function(j){if(this.isFullyLoaded()){return
}if(this.coreZoneStart<j&&j<this.coreZoneEnd){return}if(this.lazyDisplayTimeout!=null){this.home.getDocument().defaultView.clearTimeout(this.lazyDisplayTimeout);this.lazyDisplayTimeout=null}var k=this;this.lazyDisplayTimeout=this.home.getDocument().defaultView.setTimeout(function(){k.lazyDisplay(j)},i)};var i=250;var e=2.5;var g=0.25;var d=1000;c.lazyDisplay=function(n){if(this.isDestroyed()){return
}if(this.feedLocationIndex==null){return}this.waitingDisplayQueue=[];this.updateFeedLocationIndex();this.coreZoneStart=n-g*d;this.coreZoneEnd=n+d+g*d;var j=n-e*d;var k=n+d+e*d;for(var l=0;l<this.feedLocationIndex.length;l++){var m=this.feedLocationIndex[l];if(m.end<j){continue}if(m.start>k){break}if(b(m,this.coreZoneStart,this.coreZoneEnd)){this.scheduleDisplayFeed(m,0)
}else{if(b(m,j,k)){this.scheduleDisplayFeed(m,1)}}}this.processDisplayWaitingQueue()};function b(l,j,k){return l.start>=j&&l.start<=k||l.end>=j&&l.end<=k||l.start<=j&&l.end>=k}c.scheduleDisplayFeed=function(k,j){if(this.displayedSubscriptionIndex[k.feedId]!=null){return}if(this.pendingDisplayQueue[k.feedId]!=null){return}if(k.part.nbrEntries==0){this.pageModel.index[k.feedId].entries=[];
this.displayedSubscriptionIndex[k.feedId]=true}this.element("main_"+k.feedId+"_entries").innerHTML=templates.page.category.loading(k.part.nbrEntries,j,this.home);if(j==0){this.askDisplayFeed(k,j)}else{this.waitingDisplayQueue.push({fl:k,priority:j})}};c.processDisplayWaitingQueue=function(){if(this.pendingDisplayQueueSize>0){return}if(this.waitingDisplayQueue.length==0){return
}var j=this;this.home.getDocument().defaultView.setTimeout(function(){j.doProcessDisplayWaitingQueue()},0)};c.doProcessDisplayWaitingQueue=function(){if(this.isDestroyed()){return}if(this.pendingDisplayQueueSize>0){return}if(this.waitingDisplayQueue.length==0){return}var j=this.waitingDisplayQueue.shift();this.askDisplayFeed(j.fl,j.priority);this.processDisplayWaitingQueue()
};c.askDisplayFeed=function(m,l){var k=m.feedId;var j=m.part.nbrEntries;this.pendingDisplayQueue[k]=true;this.pendingDisplayQueueSize++;this.askFeedEntries(k,j)};c.onPageScrollChanged=function(j){this.askLazyDisplay(j)};c.askFeedEntries=function(l,j){if(this.reader==null){return}var n=this.reader.lookupSubscription(l);var k=n==null||n.unreadCount==null?-1:n.unreadCount;
if(this.hideReadArticlesFilter()==false||k<20){var m=this;this.reader.askEntries(l,{xt:this.hideReadArticlesFilter()?"read":null},j,function(o){m.onEntriesReady(l,o)},function(p,o){m.onEntriesError(l,p,o)})}else{var m=this;this.reco.askFeedDigest(l,j,function(o){m.onEntriesReady(l,o)},function(p,o){m.onEntriesError(l,p,o)})}};c.updatePageTitleHint=function(){var j=this.element("pageTitleHint");
if(j!=null){j.innerHTML=templates.page.category.pageTitleHint(this.categoryLabel,this.reader.getCategoryUnreadCount(this.categoryLabel),this.home)}};c.determinePageNumber=function(j){if(j<=2){return 0}else{return 1+Math.floor((j-2)/3)}};c.onEntriesReady=function(k,j){if(this.isDestroyed()||this.pageModel.index[k]==null){return}this.displayEntries(k,j)
};c.onEntriesError=function(j,m,k){var l=this.element("main_"+j+"_entries");if(l!=null){l.innerHTML=m+" -- "+k}};c.displayEntries=function(k,r){try{if(r.length>0){var m=this.reader.lookupEntry(r[0]);this.element("main_"+k+"_title").href=m.getSourceAlternateLink()}var n=[];this.pageModel.index[k].entries=[];for(var o=0;o<this.pageModel.index[k].nbrEntries&&o<r.length;
o++){var t=this.reader.lookupEntry(r[o]);if(this.featuredIndex[t.getId()]!=null){continue}var q=this.pageModel.index[k].type;if(q=="4"&&o>=4){q="12"}n.push({entry:t,type:q});this.pageModel.index[k].entries.push(t)}if(this.pageModel.index[k].entries.length>0){var s=this.element("main_"+k+"_entries");s.innerHTML=templates.page.base.parts(n,this.width,{includeFavIcon:true},this.home);
s.style.height="auto";for(var o=0;o<n.length;o++){if(n[o].type=="4"||n[o].type=="6"||n[o].type=="7"){this.askFindVisual(n[o].entry,"U"+n[o].type)}}}else{var s=this.element("main_"+k);if(s!=null){s.style.display="none"}}this.pendingAskEntriesRequests--;this.displayedSubscriptionIndex[k]=true;this.displayedSubscriptionCount++;if(this.requestedSelectedEntryId!=null&&this.selectedEntryId==null){for(var o=0;
o<r.length;o++){if(r[o]==this.requestedSelectedEntryId){this.selectEntry(this.requestedSelectedEntryId,false)}}}this.pendingDisplayQueue[k]=null;this.pendingDisplayQueueSize--;this.processDisplayWaitingQueue()}catch(p){var l=devhd.utils.ExceptionUtils.formatError("display articles",p);h.error(633,"displayEntries ",p);var j=this.element("main_"+k+"_entries");
j.innerHTML=l}};c.onSubscriptionAdded=function(k,j,l){if(l==true){return}this.feedly.reloadPage()};c.onSubscriptionRemoved=function(j){if(this.pageModel.index[j]==null){return}this.feedly.reloadPage({forceRecreate:false,disableAutoMarkAsRead:true})};c.markAsRead=function(j){var k=this;this.markCategoryAsRead(this.categoryLabel,j,function(){if(j!=null){k.feedly.refresh()
}});this.popup.hide()};c.markAsReadOneDay=function(){this.markAsRead(new Date().getTime()-devhd.utils.DurationUtils.DAYS(1))};c.markAsReadOneWeek=function(){this.markAsRead(new Date().getTime()-devhd.utils.DurationUtils.DAYS(7))};c.markPageAsRead=function(){this.signs.setMessage(f(295),100);var j=this;this.home.getDocument().defaultView.setTimeout(function(){if(j.topArea!=null){j.topArea.markAllAsRead()
}for(var l=0;l<j.pageModel.parts.length;l++){var m=j.pageModel.parts[l];if(m.entries!=null&&m.entries.length>0){for(var k=0;k<m.entries.length;k++){j.reader.markEntryAsRead(m.entries[k].getId())}}}},15)};c.onSubscriptionMarkedAsRead=function(j){if(this.pageModel.index[j]==null){return}for(var k=0;k<this.pageModel.parts.length;k++){var l=this.pageModel.parts[k];
if(l.entries!=null&&l.entries.length>0&&l.entries[0].getFeedId()==j){this.pageModel.parts.splice(k,1);break}}this.effects.fade(this.element("main_"+j),{delay:1,from:1,to:0,onComplete:function(m){devhd.utils.HTMLUtils.remove(m)}},"feedly");this.state="loaded"};c.onSubscriptionRemoved=function(j,l){if(l==true){return}if(this.pageModel.index[j]==null){return
}for(var k=0;k<this.pageModel.parts.length;k++){var m=this.pageModel.parts[k];if(m.entries!=null&&m.entries.length>0&&m.entries[0].getFeedId()==j){this.pageModel.parts.splice(k,1);break}this.pageModel.index[j]=null}this.effects.fade(this.element("main_"+j),{delay:1,from:1,to:0,onComplete:function(n){devhd.utils.HTMLUtils.remove(n)}},"feedly")};c.findNextEntryId=function(q){var p=false;
if(this.selectedEntryId==null){p=true}if(this.topArea!=null){var k=this.topArea.findNextEntyId(this.selectedEntryId,q);if(k===true){p=true}else{if(k!=null){return k}}}for(var o=0;o<this.pageModel.parts.length;o++){var r=this.pageModel.parts[o];if(r.entries!=null&&r.entries.length>0){for(var m=0;m<r.entries.length;m++){if(p==true){if(q==true){var n=r.entries[m].getId();
var l=this.reader.lookupEntry(n);if(l.isRead()==false){return n}else{continue}}else{return r.entries[m].getId()}}if(r.entries[m].getId()==this.selectedEntryId){p=true}}}}return null};c.onNextEntry=function(l,j){var k=this.findNextEntryId(l);if(k!=null){if(j==true){this.selectEntry(k,"toview")}else{this.inlineEntry(k,true)}}else{if(this.isFullyLoaded()==true){this.feedly.loadNextPage({selectEntry:true,navigationMode:"keyboard"})
}else{this.signs.setMessage(f(109))}}};c.findPreviousEntryId=function(q){var p=false;if(this.selectedEntryId==null){p=true}for(var o=this.pageModel.parts.length-1;o>=0;o--){var r=this.pageModel.parts[o];if(r.entries!=null&&r.entries.length>0){for(var m=r.entries.length-1;m>=0;m--){if(p==true){if(q==true){var n=r.entries[m].getId();var l=this.reader.lookupEntry(n);
if(l.isRead()==false){return n}else{continue}}else{return r.entries[m].getId()}}if(r.entries[m].getId()==this.selectedEntryId){p=true}}}}if(this.topArea!=null){var k=this.topArea.findPreviousEntyId(p==true?null:this.selectedEntryId,q);if(k!==true&&k!==false){return k}}};c.onPreviousEntry=function(l,j){var k=this.findPreviousEntryId(l);if(k!=null){if(j==true){this.selectEntry(k,"toview")
}else{this.inlineEntry(k,true)}}else{this.feedly.loadPreviousPage({selectEntry:true,navigationMode:"keyboard"})}};c.onCategoryUnreadCountChanged=function(j,k,l){if(this.categoryLabel!=j&&this.categoryLabel!="#latest"){return}if(l==true){return}this.updatePageTitleHint()};c.onNewEntriesAvailable=function(k,l,j){if(this.feedly==null){return}}})();
var logEnabled=false;Function.prototype._FunctionOverrides={};if(typeof Function.prototype.inherit=="function"){Function.prototype._FunctionOverrides.inherit=Function.prototype.inherit;}if(typeof Function.prototype.inherits=="function"){Function.prototype._FunctionOverrides.inherits=Function.prototype.inherits;}Function.prototype.inherit=function(c,b){if(c.constructor==Function){this.prototype=new c;this.prototype.constructor=this;this.prototype.parent=c.prototype;this.constructor.parent=c;}else{this.prototype=c;this.prototype.constructor=this;this.prototype.parent=c;this.constructor.parent=c;}if(b){for(var a in c.prototype.constructor){if(a!="parent"&&a!="prototype"&&c.constructor[a]!=c.prototype.constructor[a]){this.prototype.constructor[a]=c.prototype.constructor[a];}}}if(typeof this.prototype.handleInheritance=="function"){this.prototype.handleInheritance.apply(this,arguments);}if(typeof this._FunctionOverrides=="function"){this._FunctionOverrides.apply(this,arguments);}return this;};Function.prototype.inherits=function(a){return(typeof this.prototype.parent!="undefined"&&this.prototype.parent.constructor==a);};function Clip(b,a){this.__defineGetter__("fullPage",this.isFullPage);this.__defineGetter__("length",this.getLength);this.__defineGetter__("stylingStrategy",this.getStylingStrategy);this.__defineSetter__("stylingStrategy",this.setStylingStrategy);this.initialize(b,a);}Clip.NOKEEP_NODE_ATTRIBUTES={style:null,"class":null,id:null};Clip.NOKEEP_NODE_NAMES={style:null,script:null,input:null,select:null,option:null,textarea:null};Clip.SELF_CLOSING_NODE_NAMES={base:null,basefont:null,frame:null,link:null,meta:null,area:null,br:null,col:null,hr:null,img:null,input:null,param:null};Clip.NODE_NAME_TRANSLATIONS={body:"div",form:"div"};Clip.LIST_NODE_NAMES={ul:null,ol:null};Clip.HTMLEncode=function(e){var b="";for(var d=0;d<e.length;d++){var c=e.charCodeAt(d);var a=e[d];if(c>127){b+="&#"+c+";";}else{if(a==">"){b+="&gt;";}else{if(a=="<"){b+="&lt;";}else{if(a=="&"){b+="&amp;";}else{b+=e[d];}}}}}return b;};Clip.prototype.title=null;Clip.prototype.location=null;Clip.prototype.window=null;Clip.prototype.selectionFinder=null;Clip.prototype.deep=true;Clip.prototype._stylingStrategy=null;Clip.prototype.initialize=function(b,a){this.title=b.document.title;this.location=b.location;this.window=b;this.selectionFinder=new SelectionFinder(b.document);this.range=null;if(a){this.stylingStrategy=a;}};Clip.prototype.isFullPage=function(){return !this.hasSelection();};Clip.prototype.hasSelection=function(){if(this.selectionFinder.hasSelection()){return true;}else{this.findSelection();return this.selectionFinder.hasSelection();}};Clip.prototype.findSelection=function(){this.selectionFinder.find(this.deep);};Clip.prototype.getSelection=function(){if(this.hasSelection()){return this.selectionFinder.selection;}return null;};Clip.prototype.getRange=function(){if(this.hasSelection()){return this.selectionFinder.getRange();}return null;};Clip.prototype.hasBody=function(){return(this.window&&this.window.document&&this.window.document.body&&this.window.document.body.tagName.toLowerCase()=="body");};Clip.prototype.hasContentToClip=function(){return(this.hasBody()||this.hasSelection());};Clip.prototype.clipBody=function(){if(!this.hasBody()){if(logEnabled){console.log("Document has no body...");}return false;}var a=0;var b=0;if(logEnabled){console.log("Getting body text: "+this);a=new Date().getTime();}this.content=this.serializeDOMNode(this.window.document.body);if(logEnabled){b=new Date().getTime();console.log("Clipped body in "+(b-a)+" seconds");}if(typeof this.content!="string"){return false;}return true;};Clip.prototype.clipSelection=function(){if(!this.hasSelection()){if(logEnabled){console.log("No selection to clip");}return false;}var a=0;var b=0;this.range=this.getRange();if(this.range){if(logEnabled){var a=new Date().getTime();}this.content=this.serializeDOMNode(this.range.commonAncestorContainer);if(logEnabled){var b=new Date().getTime();}this.range=null;if(logEnabled){console.log("Success...");console.log("Clipped selection in "+(b-a)+" seconds");}return true;}this.range=null;if(logEnabled){console.log("Failure");}return false;};Clip.prototype.serializeDOMNode=function(f,h){var i="";if(this.range&&!this.range.intersectsNode(f)){if(logEnabled){console.log("Skipping serialization of node: "+f.nodeName+" cuz it's not in range...");}return i;}if(!this.keepNode(f)){if(logEnabled){console.log("Skipping seralization of node: "+f.nodeName+" cuz it's a no-keeper");}return i;}if(logEnabled){console.log("SerializeDOMNode: "+f.nodeName);}if(f.nodeType==3){if(logEnabled){console.log("Serializing text node...");}if(this.range){if(this.range.startContainer==f&&this.range.startContainer==this.range.endContainer){i+=this.constructor.HTMLEncode(f.nodeValue.substring(this.range.startOffset,this.range.endOffset));}else{if(this.range.startContainer==f){i+=this.constructor.HTMLEncode(f.nodeValue.substring(this.range.startOffset));}else{if(this.range.endContainer==f){i+=this.constructor.HTMLEncode(f.nodeValue.substring(0,this.range.endOffset));}else{if(this.range.commonAncestorContainer!=f){i+=this.constructor.HTMLEncode(f.nodeValue);}}}}}else{i+=this.constructor.HTMLEncode(f.nodeValue);}}else{if(f.nodeType==1){if(this.range&&this.range.commonAncestorContainer==f&&this.range.startContainer!=this.range.commonAncestorContainer&&!this.isListNode(f)){if(logEnabled){console.log("Ignoring range ancestor: "+f.nodeName);}}else{if(logEnabled){console.log("Serializing node: "+f.nodeName);}var c=this.translateNodeName(f);i+="<"+c;var b=this.nodeAttributesToString(f);if(b.length>0){i+=" "+b;}if(this.stylingStrategy){if(logEnabled){console.log("Styling node: "+f.nodeName);}var k=this.stylingStrategy.styleForNode(f,h);if(logEnabled){console.dir(k);}if(k instanceof ClipStyle&&k.length>0){i+=' style="'+k.toString()+'"';}else{if(logEnabled){console.log("Empty style...");}}}if(!f.hasChildNodes()&&this.isSelfClosingNode(f)){if(logEnabled){console.log("Closing self-closing tag: "+f.nodeName);}i+="/>";}else{i+=">";}}if(f.hasChildNodes()){var e=f.childNodes;for(var g=0;g<e.length;g++){var d=e[g];if(d!=null&&d.nodeType>0&&d.nodeName!="SCRIPT"&&d.nodeName!="IFRAME"){var a=this.serializeDOMNode(d,f);if(a&&a.length>0){i+=a;}}}}if(this.range&&this.range.commonAncestorContainer==f&&!this.isListNode(f)){if(logEnabled){console.log("Ignoring range ancestor: "+f.nodeName);}}else{if(f.hasChildNodes()||!this.isSelfClosingNode(f)){i+="</"+c+">";}}}}return i;};Clip.prototype.keepNodeAttr=function(a){return(typeof a=="string"&&typeof Clip.NOKEEP_NODE_ATTRIBUTES[a.toLowerCase()]=="undefined");};Clip.prototype.keepNode=function(a){if(a){if(a.nodeType==3){return true;}else{if(a.nodeType==1){if(a.nodeName.indexOf("#")==0||!this.isNodeVisible(a)){return false;}return(typeof Clip.NOKEEP_NODE_NAMES[a.nodeName.toLowerCase()]=="undefined");}}}return false;};Clip.prototype.isNodeVisible=function(a){var b=this.getNodeStylePropertyValue(a,"display");return(b&&b!="none");};Clip.prototype.isSelfClosingNode=function(a){return(a&&typeof Clip.SELF_CLOSING_NODE_NAMES[a.nodeName.toLowerCase()]!="undefined");};Clip.prototype.isListNode=function(a){return(a&&a.nodeType==1&&typeof Clip.LIST_NODE_NAMES[a.nodeName.toLowerCase()]!="undefined");};Clip.prototype.nodeAttributesToString=function(c){var d="";var a=c.attributes;if(a!=null){for(var b=0;b<a.length;b++){if(this.keepNodeAttr(a[b].nodeName)&&a[b].nodeValue!=null&&a[b].nodeValue.length>0){d+=a[b].nodeName+'="'+a[b].nodeValue+'" ';}}}return d.replace(/\s+$/,"");};Clip.prototype.translateNodeName=function(a){if(typeof Clip.NODE_NAME_TRANSLATIONS[a.nodeName.toLowerCase()]!="undefined"){return Clip.NODE_NAME_TRANSLATIONS[a.nodeName.toLowerCase()];}return a.nodeName;};Clip.prototype.getNodeStyle=function(d,c){var b=new ClipStyle();if(logEnabled){console.log(">>> NODE: "+d.nodeName+"/"+d.nodeType);}if(d&&typeof d.nodeType=="number"&&d.nodeType==1){var e=d.ownerDocument;var a=(e.defaultView)?e.defaultView:this.window;if(c){if(logEnabled){console.log(">>> Getting computed style");console.log("... "+a.getComputedStyle(d).length);}b=new ClipStyle(a.getComputedStyle(d));}else{if(logEnabled){console.log(">>> Getting matched rules");}b=new ClipStyle(a.getMatchedCSSRules(d));}}if(logEnabled){console.log(">>> "+d.nodeName+" style: "+b.toString());}return b;};Clip.prototype.getNodeStylePropertyValue=function(c,d){if(c&&typeof c.nodeType=="number"&&c.nodeType==1&&typeof d=="string"){var e=c.ownerDocument;var a=(e.defaultView)?e.defaultView:this.window;var b=a.getComputedStyle(c);return b.getPropertyValue(d);}return null;};Clip.prototype.setStylingStrategy=function(a){if(typeof a=="function"&&a.inherits(ClipStylingStrategy)){this._stylingStrategy=new a(this.window);}else{if(a instanceof ClipStylingStrategy){this._stylingStrategy=a;}else{if(a==null){this._stylingStrategy=null;}}}};Clip.prototype.getStylingStrategy=function(){return this._stylingStrategy;};Clip.prototype.toString=function(){return"Clip["+this.location+"] "+this.title;};Clip.prototype.getLength=function(){var b=0;var c=this.toDataObject();for(var a in c){b+=(""+c[a]).length+a.length+2;}b-=1;return b;};Clip.prototype.toDataObject=function(){return{content:this.content,title:this.title,url:this.location.href,fullPage:this.fullPage};};function ClipStyle(a,b){this.__defineGetter__("filter",this.getFilter);this.__defineSetter__("filter",this.setFilter);this.initialize(a,b);}ClipStyle.stylePrefix=function(b){if(typeof b=="string"){var a=0;if((a=b.indexOf("-"))>0){return b.substring(0,a);}}return b;};ClipStyle.prototype.length=0;ClipStyle.prototype._filter=null;ClipStyle.prototype.initialize=function(b,c){this.filter=c;if(b instanceof CSSRuleList){if(b.length>0){for(var a=0;a<b.length;a++){this.addStyle(b[a].style);}}}else{if(b instanceof CSSStyleRule){this.addStyle(b.style);}else{if(b instanceof CSSStyleDeclaration){this.addStyle(b);}}}};ClipStyle.prototype.addStyle=function(b){if(b instanceof CSSStyleDeclaration&&b.length>0){for(var a=0;a<b.length;a++){var d=b[a];if(this.filter&&!this.filter(d)){continue;}var c=b.getPropertyValue(d);if(typeof this[d]=="undefined"){this.length++;}this[d]=c;}}else{if(b instanceof ClipStyle){for(var d in b){if(typeof this.constructor.prototype[d]=="undefined"){if(this.filter&&!this.filter(d)){continue;}this[d]=b[d];}}}else{if(typeof b=="object"&&b!=null){for(var a in b){if(this.filter&&!this.filter(a)){continue;}if(typeof b[a]!="function"&&typeof this.constructor.prototype[a]=="undefined"){if(typeof this[a]=="undefined"){this.length++;}this[a]=b[a];}}}}}};ClipStyle.prototype.removeStyle=function(d,c){var a=this;function f(h,g){if(typeof a[h]!="undefined"&&typeof a.constructor.prototype[h]=="undefined"&&(typeof c=="function"||a[h]==g)){if(typeof c!="function"||(typeof c=="function"&&c(h,a[h],g))){if(delete (a[h])){a.length--;}}}}if(d instanceof CSSStyleDeclaration&&d.length>0){for(var b=0;b<d.length;b++){var e=d[b];f(e,d.getPropertyValue(e));}}else{if(d instanceof ClipStyle&&d.length>0){for(var e in d){f(e,d[e]);}}}};ClipStyle.prototype.removeStyleIgnoreValue=function(a){this.removeStyle(a,function(d,c,b){return true;});};ClipStyle.styleInArray=function(c,b){if(typeof c!="string"||!(b instanceof Array)){return false;}var a=-1;var c=c.toLowerCase();var d=((a=c.indexOf("-"))>0)?c.substring(0,a).toLowerCase():c.toLowerCase();for(var a=0;a<b.length;a++){if(b[a]==c||b[a]==d){return true;}}return false;};ClipStyle.prototype.deriveStyle=function(c,a,b){this.removeStyle(c,function(f,e,d){if(b instanceof Array&&ClipStyle.styleInArray(f,b)){return false;}return(typeof a[f]=="undefined"&&e==d);});};ClipStyle.prototype.setFilter=function(a){if(typeof a=="function"){this._filter=a;}else{if(a==null){this._filter=null;}}};ClipStyle.prototype.getFilter=function(){return this._filter;};ClipStyle.prototype.mergeStyle=function(c,b){if(c instanceof ClipStyle&&c.length==0){for(var a in c){if(typeof this.constructor.prototype[a]!="undefined"){continue;}if(typeof this[a]=="undefined"||b){this[a]=c[a];}}}};ClipStyle.prototype.clone=function(){var b=new ClipStyle();for(var a in this){if(typeof this.constructor.prototype[a]=="undefined"){b[a]=this[a];}}b.length=this.length;return b;};ClipStyle.prototype.toString=function(){var b="";if(this.length>0){for(var a in this){if(typeof this[a]!="string"||typeof this.constructor.prototype[a]!="undefined"||this[a].length==0){continue;}b+=a+":"+this[a]+";";}}return b;};function SelectionFinder(a){this.initDocument=a;this.document=a;}SelectionFinder.prototype.initDocument=null;SelectionFinder.prototype.document=null;SelectionFinder.prototype.selection=null;SelectionFinder.prototype.findNestedDocuments=function(f){var b=new Array();var g=f.getElementsByTagName("frame");if(g.length>0){for(var a=0;a<g.length;a++){b.push(g[a].contentDocument);}}var d=f.getElementsByTagName("iframe");try{if(d.length>0){for(var a=0;a<d.length;a++){var f=d[a].contentDocument;if(f){b.push(f);}}}}catch(c){}return b;};SelectionFinder.prototype.reset=function(){this.document=this.initDocument;this.selection=null;};SelectionFinder.prototype.hasSelection=function(){var a=this.getRange();if(a&&(a.startContainer!=a.endContainer||(a.startContainer==a.endContainer&&a.startOffset!=a.endOffset))){return true;}return false;};SelectionFinder.prototype.find=function(a){var b=this._findSelectionInDocument(this.document,a);this.document=b.document;this.selection=b.selection;};SelectionFinder.prototype.getRange=function(){if(!this.selection||this.selection.rangeCount==0){return null;}if(typeof this.selection.getRangeAt=="function"){return this.selection.getRangeAt(0);}else{var a=this.document.createRange();a.setStart(this.selection.anchorNode,this.selection.anchorOffset);a.setEnd(this.selection.focusNode,this.selection.focusOffset);return a;}return null;};SelectionFinder.prototype._findSelectionInDocument=function(e,b){var d=null;if(typeof e.getSelection=="function"){d=e.getSelection();}else{if(e.selection&&typeof e.selection.createRange=="function"){d=e.selection.createRange();}}if(d&&d.rangeCount==0&&b){if(logEnabled){console.log("Empty range, trying frames");}var f=this.findNestedDocuments(e);if(logEnabled){console.log("# of nested docs: "+f.length);}if(f.length>0){for(var c=0;c<f.length;c++){if(f[c]){if(logEnabled){console.log("Trying nested doc: "+f[c]);}var a=this._findSelectionInDocument(f[c],b);if(a.selection.rangeCount>0){return a;}}}}}return{document:e,selection:d};};function ClipStylingStrategy(a){this.initialize(a);}ClipStylingStrategy.prototype.initialize=function(a){this.window=a;};ClipStylingStrategy.prototype.styleForNode=function(b,a){return null;};ClipStylingStrategy.prototype.getNodeStyle=function(e,d,c){var b=new ClipStyle();if(logEnabled){console.log(">>> NODE: "+e.nodeName+"/"+e.nodeType);}if(e&&typeof e.nodeType=="number"&&e.nodeType==1){var f=e.ownerDocument;var a=(f.defaultView)?f.defaultView:this.window;if(d){if(logEnabled){console.log(">>> Getting computed style");console.log("... "+a.getComputedStyle(e).length);}b=new ClipStyle(a.getComputedStyle(e),c);}else{if(logEnabled){console.log(">>> Getting matched rules");}b=new ClipStyle(a.getMatchedCSSRules(e),c);}}if(logEnabled){console.log(">>> "+e.nodeName+" style: "+b.toString());}return b;};function ClipTextStylingStrategy(a){this.initialize(a);}ClipTextStylingStrategy.inherit(ClipStylingStrategy);ClipTextStylingStrategy.FORMAT_NODE_NAMES={b:null,big:null,em:null,i:null,small:null,strong:null,sub:null,sup:null,ins:null,del:null,s:null,strike:null,u:null,code:null,kbd:null,samp:null,tt:null,"var":null,pre:null,listing:null,plaintext:null,xmp:null,abbr:null,acronym:null,address:null,bdo:null,blockquote:null,q:null,cite:null,dfn:null};ClipTextStylingStrategy.STYLE_ATTRS={font:null,text:null,color:null};ClipTextStylingStrategy.prototype.isFormatNode=function(a){return(a&&a.nodeType==1&&typeof ClipTextStylingStrategy.FORMAT_NODE_NAMES[a.nodeName.toLowerCase()]!="undefined");};ClipTextStylingStrategy.prototype.hasTextNodes=function(b){if(b&&b.nodeType==1&&b.childNodes.length>0){for(var a=0;a<b.childNodes.length;a++){if(b.childNodes[a].nodeType==3){if(logEnabled){console.log("Node "+b.nodeName+" has text nodes");}return true;}}}return false;};ClipTextStylingStrategy.prototype.styleFilter=function(b){var a=ClipStyle.stylePrefix(b.toLowerCase());if(typeof ClipTextStylingStrategy.STYLE_ATTRS[a]!="undefined"){return true;}else{if(logEnabled){console.log("Filter excluding: "+b);}}};ClipTextStylingStrategy.prototype.styleForNode=function(c,a){var b=null;if(this.isFormatNode(c)||this.hasTextNodes(c)){b=this.getNodeStyle(c,true,this.styleFilter);}return b;};function ClipFullStylingStrategy(a){this.initialize(a);}ClipFullStylingStrategy.inherit(ClipStylingStrategy);ClipFullStylingStrategy.ALWAYS_KEEP={"*":["font","text","color"],img:["width","height"]};ClipFullStylingStrategy.prototype.styleForNode=function(f,a){var b=null;if(f&&f.nodeType==1){b=this.getNodeStyle(f,true);if(a){if(logEnabled){console.log("Deriving style...");}var e=this.getNodeStyle(f,false);var d=this.getNodeStyle(a,true);var c=(typeof ClipFullStylingStrategy.ALWAYS_KEEP[f.nodeName.toLowerCase()]!="undefined")?ClipFullStylingStrategy.ALWAYS_KEEP[f.nodeName.toLowerCase()]:ClipFullStylingStrategy.ALWAYS_KEEP["*"];b.deriveStyle(d,e,c);}}return b;};var clip=null;function notifyWithClip(c,a,b){if(c instanceof Clip){if(logEnabled){console.log("Total length: "+c.length);}var d=c.toDataObject();d[REQUEST_TYPE]=a;if(typeof b=="string"){d[REQUEST_MESSAGE]=b;}if(logEnabled){console.log("Notifying extension with clip: "+JSON.stringify(d));}chrome.extension.sendRequest(d);}}function notify(c,a,b){if(typeof c!="object"||c==null){c={};}if(a){c[REQUEST_TYPE]=a;}if(b){c[REQUEST_MESSAGE]=b;}chrome.extension.sendRequest(c);}function main(a,b){if(logEnabled){console.log("Contentscript clipping...");}if(logEnabled){console.log("Cancelling timeout...");}notify(null,RequestType.CANCEL_PAGE_CLIP_TIMER);clip=new Clip(window,b);if(logEnabled){console.log("CLIP: "+clip.toString());}try{if(clip.hasSelection()&&clip.clipSelection()){if(logEnabled){console.log("Successful clip of selection: "+clip.toString());}notifyWithClip(clip,RequestType.PAGE_CLIP_SUCCESS);}else{if(clip.hasBody()){notifyWithClip(clip,RequestType.PAGE_CLIP_SUCCESS);if(a){if(clip.clipBody()){if(clip.length>=(Limits.CLIP_NOTE_CONTENT_LEN_MAX-1024)){if(logEnabled){console.log("Notifying full page clip failure");}notifyWithClip(clip,RequestType.PAGE_CLIP_CONTENT_FAILURE,chrome.i18n.getMessage("fullPageClipTooBig"));}else{if(logEnabled){console.log("Notifying full page clip success");}notifyWithClip(clip,RequestType.PAGE_CLIP_CONTENT_SUCCESS);}}else{notify(null,RequestType.PAGE_CLIP_CONTENT_FAILURE,chrome.i18n.getMessage("fullPageClipFailure"));}}}else{if(logEnabled){console.log("Failed to clip full page");}notify(null,RequestType.PAGE_CLIP_FAILURE,chrome.i18n.getMessage("fullPageClipFailure"));}}}catch(c){if(logEnabled){console.log("Exception clipping page or its selection"+((typeof c.message!="undefined")?": "+c.message:""));}notify(null,RequestType.PAGE_CLIP_FAILURE,c.message);}if(logEnabled){console.log("Done clipping...");}}
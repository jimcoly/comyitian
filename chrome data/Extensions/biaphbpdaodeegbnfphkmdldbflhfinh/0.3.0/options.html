<html>
<head>
<title>Mark for Later Options</title>
<script src="javascript/jquery-1.4.2.min.js"></script>
<script src="javascript/apikey.js"></script>
</head>
<body>
<span>Username:</span>
<input
    id="login"
    type="text"></input>
<span>Password:</span>
<input
    id="pass"
    type="password"></input>
<div id="status"></div>
<div>
<button id="login_button" onclick="save_options();">log in</button>
<div><a href="" onclick="signup();" title="sign up">Sign up for a new account</a></div>
</div>
<script type="text/javascript">
    if (typeof(localStorage["RFL.login"]) == "undefined"){
        document.getElementById("login").value = "";
        document.getElementById("pass").value = "";
    }else{
        document.getElementById("login").value = localStorage["RFL.login"];
        document.getElementById("pass").value = localStorage["RFL.pass"];
    }
    // Saves options to localStorage.
    function save_options() {
        var reqUrl = "https://readitlaterlist.com/v2/auth?username="
                + escape(document.getElementById("login").value) + "&password="
                + escape(document.getElementById("pass").value) + "&apikey="
                + apiKey;
        var status = document.getElementById("status");
        $("#status").show();
        status.innerHTML = "connecting...";
        $.ajax( {
            url : reqUrl,
            complete : function(XMLHttpRequest, textStatus) {
                if (XMLHttpRequest.status == 200) {
                    status.innerHTML = "Authentication successful. Login information saved.";
                    localStorage["RFL.login"] = document
                            .getElementById("login").value;
                    localStorage["RFL.pass"] = document
                            .getElementById("pass").value;
                    setTimeout(function() {
                        chrome.tabs.getSelected(null, function(tab) {
                            chrome.tabs.update(tab.id, {
                                url : tab.url,
                                selected : tab.selected
                            }, null);
                        });
                    }, 1000);
                } else if (XMLHttpRequest.status == 401) {
                    status.innerHTML = "<div>Authentication failed</div>"
                            + XMLHttpRequest.status + 
                            " <div><a href=\"\" onclick=\"forgot()\">Forgot your password?</a></div>";
                    $("#login_button").text("try again");
                } else if (XMLHttpRequest.status == 403) {
                    status.innerHTML = "<div>Authentication failed</div>"
                            + XMLHttpRequest.status + 
                            " <div><a href=\"\" onclick=\"forgot()\">Forgot your password?</a></div>";
                    $("#login_button").text("try again");
                } else {
                    status.innerHTML = "Connection error "
                            + XMLHttpRequest.status;
                    $("#login_button").text("try again");
                }
            }
        });
    }
    function signup(){
        chrome.tabs.getSelected(null, function(tab) {
            chrome.tabs.update(tab.id, {
                url : "http://readitlaterlist.com/signup/",
                selected : tab.selected
            }, null);
        });
    }

    function forgot(){
        chrome.tabs.getSelected(null, function(tab) {
            chrome.tabs.update(tab.id, {
                url : "http://readitlaterlist.com/forgot/",
                selected : tab.selected
            }, null);
        });
    }
</script>

</body>
</html>
